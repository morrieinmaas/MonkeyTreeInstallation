EasySocial.module("story/project",function(a){var b=this,c=EasySocial.options.momentLang;EasySocial.require().library("datetimepicker","moment/"+c).view("site/loading/small").language("COM_EASYSOCIAL_STORY_PROJECT_INSUFFICIENT_DATA","COM_EASYSOCIAL_STORY_PROJECT_INVALID_START_END_DATETIME").done(function(){EasySocial.Controller("Story.Project",{defaultOptions:{"{base}":"[data-story-project-base]","{category}":"[data-story-project-category]","{form}":"[data-story-project-form]","{timezone}":"[data-project-timezone]","{datetimeForm}":"[data-project-datetime-form]","{datetime}":"[data-project-datetime]","{title}":"[data-project-title]","{description}":"[data-project-description]",view:{loading:"site/loading/small"}}},function(b){return{init:function(){},"{category} change":function(c){c.val()?(b.form().show().html(b.view.loading()),b.loadStoryForm(c.val()).done(function(c){b.form().html(c);
var e,d=b.datetimeForm().htmlData();e=a.isEmpty(d.yearto)?(new Date).getFullYear()+100:parseInt(d.yearto)+1,a.extend(b.options,{yearfrom:d.yearfrom||1930,yearto:e,allowTime:d.allowtime,allowTimezone:d.allowtimezone,dateFormat:d.dateformat,disallowPast:d.disallowpast,minuteStepping:parseInt(d.minutestepping)}),b.datetime().addController("EasySocial.Controller.Story.Projects.Datetime",{"{parent}":b})})):b.form().hide().html("")},loadStoryForm:a.memoize(function(a){return EasySocial.ajax("apps/user/projects/controllers/projects/loadStoryForm",{id:a})
}),"{story} save":function(a,c,d){if("project"==d.currentPanel){var e={title:b.title().val(),description:b.description().val(),category:b.category().val()};b.options.allowTimezone&&(e.timezone=b.timezone().val()),b.datetime().trigger("datetimeExport",[e]),b.options.name="project";var f=d.addTask("validateProjectForm");b.save(f,e)}},save:function(c,d){return a.isEmpty(d.title)||a.isEmpty(d.category)||a.isEmpty(d.start)?c.reject(a.language("COM_EASYSOCIAL_STORY_PROJECT_INSUFFICIENT_DATA")):!a.isEmpty(d.start)&&!a.isEmpty(d.end)&&d.end<d.start?c.reject(a.language("COM_EASYSOCIAL_STORY_PROJECT_INVALID_START_END_DATETIME")):(c.save.addData(b,d),c.resolve(),void 0)
}}}),EasySocial.Controller("Story.Projects.Datetime",{defaultOptions:{type:null,"{picker}":"[data-picker]","{toggle}":"[data-picker-toggle]","{datetime}":"[data-datetime]"}},function(b){return{init:function(){b.options.type=b.element.data("project-datetime");var d=new a.moment;b.parent.options.disallowPast?d.date(d.date()-1):d.year(b.parent.options.yearfrom),b.picker()._datetimepicker({component:"es",useCurrent:!1,format:b.parent.options.dateFormat,minDate:d,maxDate:new a.moment({y:b.parent.options.yearto}),icons:{time:"glyphicon glyphicon-time",date:"glyphicon glyphicon-calendar",up:"glyphicon glyphicon-chevron-up",down:"glyphicon glyphicon-chevron-down"},sideBySide:!1,pickTime:1==b.parent.options.allowTime,minuteStepping:b.parent.options.minuteStepping,language:c});
var e=a.moment();e.minute(0),e.second(0),"end"==b.options.type&&e.hour(e.hour()+1),b.datetimepicker("setDate",e)},datetimepicker:function(a,c){return b.picker().data("DateTimePicker")[a](c)},"{toggle} click":function(){b.picker().focus()},"{picker} dp.change":function(c,d){b.setDateValue(d.date.toDate()),b.parent.element.trigger("project"+a.String.capitalize(b.options.type),[d.date])},setDateValue:function(a){b.datetime().val(a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2)+" "+("00"+a.getHours()).slice(-2)+":"+("00"+a.getMinutes()).slice(-2)+":"+("00"+a.getSeconds()).slice(-2))
},"{parent} projectStart":function(){"start"===b.options.type},"{parent} projectEnd":function(){"end"===b.options.type},"{self} datetimeExport":function(a,c,d){d[b.options.type]=b.datetime().val()}}}),b.resolve()})})